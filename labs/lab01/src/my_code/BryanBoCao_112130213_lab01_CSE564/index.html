<!DOCTYPE html>
<!--
Student: Bryan Bo Cao
SBU ID: 112130213

Apply 3 color scheme from Cool Blues (https://www.canva.com/learn/100-color-combinations/),
which are (#003B46, #07575B, #66A5AD, #C4DFE6) to make the whole theme consistent.

Note that I watched the videos from https://www.youtube.com/watch?v=n5NcCoa9dDU&list=PL6il2r9i3BqH9PmbOf5wA5E1wOG3FT22p&index=1
and the code are based on the basics I learned from the videos.

Dataset:
College 777 data points, 18 dimensions
https://vincentarelbundock.github.io/Rdatasets/datasets.html

Reference:
https://getbootstrap.com/docs
https://www.w3schools.com
https://www.youtube.com/watch?v=kMCnzUE07QA
-->
<html lang="en">
<head>
    <!--  <script src="../d3.min.js"></script> Use D3 library from CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    #value_on_bar {
      font-size: 20px;
      background-color: #66A5AD;
      padding: .30em;
      color: white;
      border-radius: 6px;
      pointer-events: none;
      position: absolute;
    }

    .hidden {
      display: none;
    }
    </style>
</head>
<body>

  <div class="page-header" align="center">
    <h2>Student: Bryan Bo Cao SBU ID: 112130213</h2>
    <hr>
    <p>Dataset: College 777 data points, 18 dimensions</p>
    <div id="dropdown_div">
      Select Attribute:
    </div>

  </div>

  <div class="container-fluid well">
    <div id="value_on_bar" class="hidden">
      <p><span id="value"></span></p>
    </div>
    <div id="canvas" onmousemove="check_lr_movement(event)" onclick="change_chart()">
      <!-- Note that check_lr_movement(event)" is for the requirement of
      7.mouse moves left (right) should decrease (increase) bin width/size -->
      <!-- To canvas div for d3 -->
      <div id="chart_div_id">
        <svg id="barchart_svg" width="960" height="500"></svg>
      </div>
    </div>

    <div id="canvas_script">

      <script>
        // parameters
        var pre_mouse_x_pos = -1; // -1 means no previous mouse x position has been assigned
        var curr_bar_w = -10; // initial value
        var max_bar_w = 70, min_bar_w = 3;
        var w = window.innerWidth, h = window.innerHeight - 450;
        var canvas_w = w - 20, canvas_h = h - 320;
        var num_bin = 10;

        // color parameters
        var my_colors = ["#003B46", "#07575B", "#66A5AD", "#C4DFE6"];
        var color_range = [d3.rgb(my_colors[0]),
                          d3.rgb(my_colors[2])];
        var my_scale_colors = d3.scaleOrdinal()
                          .range(["#003B46", "#07575B", "#66A5AD", "#C4DFE6"]);

        var format_count = d3.format(",.0f");
        var margin = 20;
        var hist;
        var barchar_svg = d3.select("#barchart_svg");
        var svg_w = barchar_svg.attr("width") - margin;
            svg_h = barchar_svg.attr("height") - margin;
        var bar_change_direction = true;
        var chart_width = 500, chart_height = 960, radius = Math.min(chart_width, chart_height) / 2;

        d3.csv("./data/College.csv", function(data) {

          var attributes = data.columns;
          attributes.shift(); // The first attribute is "", so we need to remove it.
          attributes.shift(); // clean data
          console.log(attributes)
          console.log(attributes.length)

          var attribute = attributes[0];
          var display_data = data.map(function(d) { return parseInt(d[attribute])});
          console.log(display_data)

          var canvas = d3.select("#canvas")
                          .append("svg")
                          .attr("width", canvas_w)
                          .attr("height", canvas_h);

          function init_barchart(display_data_values) {

            console.log("init_barchart()");
            var g = barchar_svg.append("g")
                        .attr("transform", "translate(" + margin + ")");

            var x_min = d3.min(display_data_values),
                x_max = d3.max(display_data_values),
                x_range = [0, svg_w],
                x_domain = [0, x_max];

            var x_scale = d3.scaleLinear()
                      .range(x_range)
              				.domain(x_domain);

            var hist = d3.histogram()
                          .domain(x_domain)
                          .thresholds(x_scale.ticks(num_bin))
                          (display_data_values);

            var y_min = d3.min(hist, function(d) { return d.length; }),
                y_max = d3.max(hist, function(d) { return d.length; }),
                y_range = [svg_h, 0],
                y_domain = [0, y_max];

            var y_scale = d3.scaleLinear()
                      .range(y_range)
                      .domain(y_domain);

            var color_scale = d3.scaleLinear()
                                .domain([y_min, y_max])
                                .range(color_range);

            var bar_w = x_scale(hist[0].x1) - x_scale(hist[0].x0) - 50,
                bar_h = function(d) { return svg_h - y_scale(d.length)},
                bar_c = function(d) { return color_scale(d.length)}, // bar color
                bar_t = function(d) { return "translate(" + x_scale(d.x0) + "," + y_scale(d.length) + ")";}; // bar transform

            var bar = g.selectAll(".bar")
                .data(hist)
                .enter()
                .append("g")
                .attr("class", "bar")
                .attr("transform", bar_t);

            bar.append("text")
                .attr("dy", ".60em")
                .attr("y", -12)
                .attr("x", (x_scale(hist[0].x1) - x_scale(0)) / 2)
                .attr("text-anchor", "middle")
                .text("");
                // .text(function(d) {return format_count(d.length);});

            bar.append("rect")
                .attr("x", 1)
                .attr("y", 0)
                .attr("width", bar_w)
                .attr("height", bar_h)
                .attr("fill", bar_c)
                .on('mouseover', function(d){
                    d3.select("#canvas")
                      .attr("onmousemove", "null");

                    d3.select(this)
                      .transition()
                      .duration(500)
                      .attr("x", -15)
                      .attr("y", -40)
                      .attr("width", bar_w + 30)
                      .attr("height", 1800);

                    var value_x_pos = event.clientX,
                        value_y_pos = svg_h - d3.select(this).attr("height") + 150;

                		d3.select('#value_on_bar')
                			.style('left', value_x_pos + 'px')
                			.style('top', value_y_pos + 'px')
                			.select('#value')
                			.text(d.length);

                		//Show the value_on_bar
                		d3.select('#value_on_bar').classed('hidden', false);

                })
                .on("mouseout", function(d){

                      // only reset_check_lr_movement after the mouseout transition
                      // is finished after 500
                      setTimeout(reset_check_lr_movement, 501);

                      d3.select(this)
                          .transition()
                          .duration(500)
                          .attr("x", 1)
                          .attr("y", 0)
                          .attr("width", bar_w)
                          .attr("height", bar_h);
                      d3.select('#value_on_bar').classed('hidden', true);
                });

            bar.select("rect")
                .transition()
                .duration(0)
                .attr("width", bar_w)
                .attr("height", 0);

            barchar_svg.append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(10," + svg_h + ")")
                .call(d3.axisBottom(x_scale));

            bar.select("rect")
                .transition()
                .duration(500)
                .attr("width", bar_w)
                .attr("height", bar_h)
                .attr("fill", bar_c);

            d3.select("#canvas")
                .append("svg")
                .attr("id", "piechart_svg")
                .attr("width", "0")
                .attr("height", "0")
                .attr("transform", "translate(0, 0)");

          } // end of function init_barchart(display_data_values)

          function update_barchart(display_data_values) {

            console.log("update_barchart()");
            var x_min = d3.min(display_data_values),
                x_max = d3.max(display_data_values),
                x_range = [0, svg_w],
                x_domain = [0, x_max];

            var x = d3.scaleLinear()
                      .range(x_range)
              				.domain(x_domain);

            var hist = d3.histogram()
                          .domain(x_domain)
                          .thresholds(x.ticks(num_bin))
                          (display_data_values);

            var y_min = d3.min(hist, function(d) { return d.length; }),
                y_max = d3.max(hist, function(d) { return d.length; }),
                y_range = [svg_h, 0],
                y_domain = [0, y_max];

            var y = d3.scaleLinear()
                      .range(y_range)
                      .domain(y_domain);

            var bar = barchar_svg.selectAll(".bar").data(hist);

            bar.append("text")
                .attr("dy", ".60em")
                .attr("y", -12)
                .attr("x", (x(hist[0].x1) - x(0)) / 2)
                .attr("text-anchor", "middle")
                .text("");

            // Remove old data
            bar.exit().remove();

            var color_scale = d3.scaleLinear()
                                .domain([y_min, y_max])
                                .range(color_range);

            var bar_w = x(hist[0].x1) - x(hist[0].x0) - 12,
                bar_h = function(d) { return svg_h - y(d.length)},
                bar_c = function(d) { return color_scale(d.length)}, // bar color
                bar_t = function(d) { return "translate(" + x(d.x0) + "," + y(d.length) + ")";}; // bar transform

            bar.transition()
                .duration(500)
                .attr("transform", bar_t);

            console.log(display_data_values)

            bar.select("rect")
                .transition()
                .duration(0)
                .attr("width", bar_w)
                .attr("height", bar_h)
                .attr("fill", bar_c);

            // update x axis
            d3.selectAll(".xaxis").remove();
            barchar_svg.append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(0," + svg_h + ")")
                .call(d3.axisBottom(x));

            curr_bar_w = bar_w;

            bar.exit().remove();
          } // end of function update_barchart(display_data_values)

          function update_piechart(display_data_values) {

            d3.select("#piechart_svg")
              .transition()
              .duration(500)
              .attr("transform", "translate(-1000, 0)");

            setTimeout(function() {update_piechart_content(display_data_values)}, 500);
          } // end of function update_piechart(display_data_values)

          function update_piechart_content(display_data_values) {

            d3.select("#piechart_svg")
              .transition()
              .duration(500)
              .attr("transform", "translate(0, 0)");

            var x_min = d3.min(display_data_values),
                x_max = d3.max(display_data_values),
                x_range = [0, svg_w],
                x_domain = [0, x_max];

            var x_scale = d3.scaleLinear()
                      .range(x_range)
              				.domain(x_domain);

            var hist = d3.histogram()
                          .domain(x_domain)
                          .thresholds(x_scale.ticks(num_bin))
                          (display_data_values);

            var display_data4piechart = [],
                arc_text_arr = [];

            for (i = 0; i < num_bin; ++i) {
              display_data4piechart.push(hist[i].length);
              var arc_text = (hist[i].length < 1) ? "" : d3.min(hist[i]) + "-" + d3.max(hist[i]);
              arc_text_arr.push(arc_text);
            }

            console.log("init_piechart()");
            console.log(arc_text_arr);

            var piechart_svg = d3.select("#piechart_svg");
            var group = piechart_svg.append("g")
                        .attr("transform", "translate(550, 300)");
            var pie = d3.pie().value(function(d) { return d; });
            var arc = d3.arc()
                        .innerRadius(0)
                        .outerRadius(radius);

            console.log(pie(display_data4piechart));
            var arc_group = group.selectAll(".arc")
                            .data(pie(display_data4piechart))
                            .enter()
                            .append("g")
                            .attr("class", "arc");

            arc_group.append("path")
                    .attr("d", arc)
                    .attr("fill", function(d){return my_scale_colors(d.data)});

            arc_group.append("text")
                      .attr("transform", function(d){return "translate(" + arc.centroid(d) + ")";})
                      .attr("text-anchor", "middle")
                      .attr("font-size", "1em")
                      .attr("fill","white")
                      .text(function(d, i){
                        if (d.data < 20) return "";
                        else return "Range: " + arc_text_arr[i] + " Count: " + d.data});
          } // end of function update_piechart_content(display_data_values)

          init_barchart(display_data);
          update_piechart(display_data);

          // Create a dropdown
          var dropdown_menu = d3.select("#dropdown_div");

          dropdown_menu.append("select")
                      .attr("id", "dropdown_id")
                      .selectAll("option")
                          .data(attributes)
                          .enter()
                          .append("option")
                          .attr("value", function(d){return d;})
                          .text(function(d){return d;});

          d3.select("select")
            .on("change",function(d){
              var attribute = d3.select("#dropdown_id").node().value;
              var display_data = data.map(function(d) {return parseInt(d[attribute])});
              update_barchart(display_data);
              update_piechart(display_data);
          });

        }) // end of d3.csv("./data/College.csv", function(data)

        // for 7.mouse moves left (right) should decrease (increase) bin width/size
        function check_lr_movement(event) {

          var bar = d3.select("#barchart_svg")
                      .selectAll(".bar");
          var bar_w = bar.select("rect")
                          .attr("width");
          if (curr_bar_w == -10) curr_bar_w = bar_w;
          if (pre_mouse_x_pos > 0) {

            if (pre_mouse_x_pos < event.clientX) {
              // move right to make bars thicker
              curr_bar_w++;
            } else {
              // move left to make bars thinner
              curr_bar_w--;
            }
            if (curr_bar_w <= min_bar_w) curr_bar_w = min_bar_w;
            else if (curr_bar_w > max_bar_w) curr_bar_w = max_bar_w;
            bar.selectAll("rect")
                .transition()
                .duration(0)
                .attr("width", curr_bar_w);
          }
          pre_mouse_x_pos = event.clientX;
        }

        function reset_check_lr_movement() {
          d3.select("#canvas")
            .attr("onmousemove", "check_lr_movement(event)");
        }

        function change_chart() {
            console.log("change_chart!");
            if (bar_change_direction) {
              d3.select("#barchart_svg")
                .transition()
                .duration(1000)
                .attr("width", "0")
                .attr("height", "0")
                // .attr("transform", "translate(-1000, 0)");
              d3.select("#piechart_svg")
                .transition()
                .duration(1100)
                .attr("width", (chart_width + 500))
                .attr("height", chart_height)
                // .attr("transform", "translate(0, -300)");
              bar_change_direction = false;
            } else {
              d3.select("#piechart_svg")
                .transition()
                .duration(1000)
                .attr("width", "0")
                .attr("height", "0")
                // .attr("transform", "translate(-1000, -1000)");
              d3.select("#barchart_svg")
                .transition()
                .duration(1100)
                .attr("width", (chart_width + 500))
                .attr("height", chart_height)
                // .attr("transform", "translate(0, 0)");
              bar_change_direction = true;
            }

        }

      </script>
    </div>

  </div>

</body>
</html>
